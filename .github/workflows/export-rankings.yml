name: Export Rankings to GitHub

on:
  # å®šæœŸå®Ÿè¡Œ: 1æ™‚é–“ã”ã¨
  schedule:
    - cron: '0 * * * *'  # æ¯æ™‚0åˆ†ã«å®Ÿè¡Œ
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
  
  # ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«ã‚‚å®Ÿè¡Œï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
  push:
    branches:
      - main
    paths:
      - 'export-rankings.cjs'
      - '.github/workflows/export-rankings.yml'

jobs:
  export:
    runs-on: ubuntu-latest
    
    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      # ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: npm install
      
      # Firebaseã‹ã‚‰ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
      - name: Export rankings from Firebase
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: npm run export
      
      # Gitè¨­å®š
      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
      
      # å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
      - name: Commit ranking data
        run: |
          git add ranking-data/
          git diff --quiet && git diff --staged --quiet || (git commit -m "ğŸ¤– ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿è‡ªå‹•æ›´æ–° $(date +'%Y-%m-%d %H:%M:%S')")
      
      # GitHubã«ãƒ—ãƒƒã‚·ãƒ¥
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
      
      # å®Œäº†é€šçŸ¥
      - name: Success notification
        if: success()
        run: echo "âœ… ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ"
      
      - name: Failure notification
        if: failure()
        run: echo "âŒ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ"
